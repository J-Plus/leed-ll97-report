<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEED vs NYC Energy Grades — 2026 Data Explorer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root {
  --bg-deep: #060a12;
  --bg-base: #0b1120;
  --bg-card: #111827;
  --bg-card-hover: #1a2340;
  --bg-input: #0d1528;
  --border: #1e2d4a;
  --border-light: #253554;
  --text-primary: #e8edf5;
  --text-secondary: #8899b8;
  --text-muted: #4a5f85;
  --grade-a: #10b981;
  --grade-a-glow: rgba(16,185,129,.4);
  --grade-b: #06b6d4;
  --grade-b-glow: rgba(6,182,212,.4);
  --grade-c: #f59e0b;
  --grade-c-glow: rgba(245,158,11,.4);
  --grade-d: #ef4444;
  --grade-d-glow: rgba(239,68,68,.4);
  --leed-platinum: #c4b5fd;
  --leed-gold: #fbbf24;
  --leed-silver: #94a3b8;
  --leed-certified: #6ee7b7;
  --accent: #38bdf8;
  --font-display: 'Libre Baskerville', Georgia, serif;
  --font-mono: 'IBM Plex Mono', 'Menlo', monospace;
  --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
  --radius: 6px;
}
html { font-size: 15px; }
body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-primary);
  line-height: 1.5;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* --- HEADER --- */
.header {
  border-bottom: 1px solid var(--border);
  padding: 1.5rem 2.5rem 1.2rem;
  background: linear-gradient(180deg, rgba(11,17,32,.95), rgba(6,10,18,.98));
  position: relative;
  z-index: 200;
}
.header-inner { max-width: 1600px; margin: 0 auto; display: flex; align-items: baseline; justify-content: space-between; }
.header h1 {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 700;
  letter-spacing: -.01em;
  color: var(--text-primary);
}
.header h1 span { color: var(--accent); }
.header .subtitle {
  font-family: var(--font-mono);
  font-size: .7rem;
  color: var(--text-muted);
  letter-spacing: .08em;
  text-transform: uppercase;
}

/* --- FILTER BAR --- */
.filter-bar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: .6rem 2.5rem;
  display: flex;
  align-items: center;
  gap: .8rem;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 150;
}
.filter-bar label {
  font-family: var(--font-mono);
  font-size: .65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .06em;
}
.filter-group { display: flex; align-items: center; gap: .35rem; }
.filter-bar select, .filter-bar input[type="text"] {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: .75rem;
  padding: .3rem .5rem;
  border-radius: var(--radius);
  outline: none;
  transition: border-color .2s;
}
.filter-bar select:focus, .filter-bar input:focus { border-color: var(--accent); }
.filter-bar input::placeholder { color: var(--text-muted); }
.filter-bar .search-input { width: 180px; }
.btn-sm {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: .65rem;
  padding: .3rem .6rem;
  border-radius: var(--radius);
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: .05em;
  transition: all .2s;
}
.btn-sm:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm.active { border-color: var(--accent); color: var(--accent); background: var(--bg-input); }
.filter-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: .6rem;
}
.active-filters {
  font-family: var(--font-mono);
  font-size: .65rem;
  color: var(--text-muted);
}
.active-filters strong { color: var(--accent); }

/* --- LAYOUT --- */
.main-layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  height: calc(100vh - 100px);
  max-width: 1600px;
  margin: 0 auto;
}

/* --- MAP CONTAINER --- */
.map-container {
  position: relative;
  overflow: hidden;
  background: var(--bg-deep);
  cursor: grab;
}
.map-container:active { cursor: grabbing; }
.map-canvas {
  position: absolute;
  top: 0;
  left: 0;
  transform-origin: 0 0;
}

/* --- LEGEND --- */
.map-legend {
  position: absolute;
  bottom: 1.5rem;
  left: 1.5rem;
  background: rgba(11,17,32,.92);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: .8rem 1rem;
  z-index: 10;
  backdrop-filter: blur(8px);
}
.map-legend h3 {
  font-family: var(--font-mono);
  font-size: .6rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--text-muted);
  margin-bottom: .5rem;
}
.legend-row {
  display: flex;
  align-items: center;
  gap: .5rem;
  margin-bottom: .3rem;
  font-family: var(--font-mono);
  font-size: .7rem;
  color: var(--text-secondary);
}
.legend-swatch {
  width: 14px;
  height: 14px;
  border-radius: 2px;
  flex-shrink: 0;
}

/* --- ZOOM CONTROLS --- */
.zoom-controls {
  position: absolute;
  bottom: 1.5rem;
  right: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: .3rem;
  z-index: 10;
}
.zoom-btn {
  background: rgba(11,17,32,.92);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: 1rem;
  width: 32px;
  height: 32px;
  border-radius: var(--radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .15s;
  backdrop-filter: blur(8px);
}
.zoom-btn:hover { border-color: var(--accent); color: var(--accent); }

/* --- STATS COLUMN --- */
.stats-col {
  border-left: 1px solid var(--border);
  background: var(--bg-base);
  overflow-y: auto;
  padding: 0;
}
.stats-section {
  padding: 1rem 1.2rem;
  border-bottom: 1px solid var(--border);
}
.stats-section h3 {
  font-family: var(--font-mono);
  font-size: .6rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--text-muted);
  margin-bottom: .8rem;
}
.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: .5rem;
}
.stat-row .label {
  font-family: var(--font-mono);
  font-size: .72rem;
  color: var(--text-secondary);
}
.stat-row .value {
  font-family: var(--font-mono);
  font-size: .85rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* Grade breakdown bars */
.grade-bars { margin-top: .6rem; }
.grade-bar-row {
  display: flex;
  align-items: center;
  gap: .5rem;
  margin-bottom: .4rem;
}
.grade-bar-label {
  font-family: var(--font-mono);
  font-size: .72rem;
  font-weight: 600;
  width: 16px;
  text-align: center;
}
.grade-bar-track {
  flex: 1;
  height: 20px;
  background: rgba(30,45,74,.3);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}
.grade-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width .6s cubic-bezier(.25,.46,.45,.94);
  position: relative;
}
.grade-bar-count {
  font-family: var(--font-mono);
  font-size: .68rem;
  color: var(--text-secondary);
  width: 50px;
  text-align: right;
}

/* LEED level mini bars */
.leed-bars { margin-top: .4rem; }
.leed-bar-row {
  display: flex;
  align-items: center;
  gap: .5rem;
  margin-bottom: .35rem;
}
.leed-bar-label {
  font-family: var(--font-mono);
  font-size: .65rem;
  color: var(--text-secondary);
  width: 62px;
  text-align: right;
}
.leed-bar-track {
  flex: 1;
  height: 14px;
  background: rgba(30,45,74,.3);
  border-radius: 2px;
  overflow: hidden;
}
.leed-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width .6s cubic-bezier(.25,.46,.45,.94);
}
.leed-bar-count {
  font-family: var(--font-mono);
  font-size: .65rem;
  color: var(--text-muted);
  width: 30px;
}

/* --- TOOLTIP --- */
.tooltip {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  background: rgba(11,17,32,.96);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: .8rem 1rem;
  max-width: 320px;
  backdrop-filter: blur(12px);
  opacity: 0;
  transition: opacity .15s;
  box-shadow: 0 8px 32px rgba(0,0,0,.5);
}
.tooltip.visible { opacity: 1; }
.tooltip-name {
  font-family: var(--font-body);
  font-size: .85rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: .2rem;
  line-height: 1.3;
}
.tooltip-addr {
  font-family: var(--font-mono);
  font-size: .68rem;
  color: var(--text-muted);
  margin-bottom: .5rem;
}
.tooltip-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .25rem .8rem;
}
.tooltip-item label {
  font-family: var(--font-mono);
  font-size: .58rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--text-muted);
  display: block;
}
.tooltip-item span {
  font-family: var(--font-mono);
  font-size: .78rem;
  font-weight: 500;
  color: var(--text-primary);
}

/* --- BUILDING DETAIL PANEL (click) --- */
.detail-panel {
  padding: 1rem 1.2rem;
  border-bottom: 1px solid var(--border);
  display: none;
}
.detail-panel.visible { display: block; }
.detail-panel .close-btn {
  float: right;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.1rem;
  cursor: pointer;
  padding: .2rem;
  line-height: 1;
}
.detail-panel .close-btn:hover { color: var(--text-primary); }
.detail-name {
  font-family: var(--font-display);
  font-size: 1rem;
  color: var(--text-primary);
  margin-bottom: .15rem;
  padding-right: 1.5rem;
}
.detail-addr {
  font-family: var(--font-mono);
  font-size: .7rem;
  color: var(--text-muted);
  margin-bottom: .7rem;
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .5rem;
}
.detail-cell {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: .5rem .6rem;
}
.detail-cell label {
  font-family: var(--font-mono);
  font-size: .55rem;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--text-muted);
  display: block;
  margin-bottom: .15rem;
}
.detail-cell .val {
  font-family: var(--font-mono);
  font-size: .9rem;
  font-weight: 600;
}

/* --- BUILDING LIST --- */
.building-list-section { padding: 0; }
.building-list-header {
  padding: .8rem 1.2rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg-base);
  z-index: 5;
}
.building-list-header h3 { margin: 0; }
.building-list {
  max-height: none;
  overflow: visible;
}
.building-item {
  display: flex;
  align-items: center;
  gap: .6rem;
  padding: .5rem 1.2rem;
  border-bottom: 1px solid rgba(30,45,74,.3);
  cursor: pointer;
  transition: background .15s;
}
.building-item:hover { background: var(--bg-card-hover); }
.building-item .grade-dot {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  flex-shrink: 0;
}
.building-item .info {
  flex: 1;
  min-width: 0;
}
.building-item .name {
  font-family: var(--font-body);
  font-size: .75rem;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.building-item .meta {
  font-family: var(--font-mono);
  font-size: .6rem;
  color: var(--text-muted);
}
.building-item .es-score {
  font-family: var(--font-mono);
  font-size: .7rem;
  font-weight: 500;
  color: var(--text-secondary);
  flex-shrink: 0;
}

/* --- LOADING --- */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg-deep);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity .5s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text {
  font-family: var(--font-mono);
  font-size: .75rem;
  color: var(--text-muted);
  margin-top: 1rem;
  letter-spacing: .08em;
  text-transform: uppercase;
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.fade-in { animation: fadeIn .4s ease both; }
</style>
</head>
<body>
<div class="loading-overlay" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading buildings&hellip;</div>
</div>

<div class="tooltip" id="tooltip">
  <div class="tooltip-name" id="ttName"></div>
  <div class="tooltip-addr" id="ttAddr"></div>
  <div class="tooltip-grid">
    <div class="tooltip-item"><label>Grade</label><span id="ttGrade"></span></div>
    <div class="tooltip-item"><label>LEED Level</label><span id="ttLeed"></span></div>
    <div class="tooltip-item"><label>ENERGY STAR</label><span id="ttES"></span></div>
    <div class="tooltip-item"><label>Site EUI</label><span id="ttEUI"></span></div>
  </div>
</div>

<header class="header">
  <div class="header-inner">
    <h1>LEED Buildings <span>Failing</span> NYC Energy Grades</h1>
    <div class="subtitle">273 LEED Buildings with Failing Energy Grades &mdash; Manhattan</div>
  </div>
</header>

<div class="filter-bar">
  <div class="filter-group">
    <label>LEED</label>
    <select id="filterLeed"><option value="">All</option><option>Platinum</option><option>Gold</option><option>Silver</option><option>Certified</option></select>
  </div>
  <div class="filter-group">
    <label>Type</label>
    <select id="filterType"><option value="">All</option></select>
  </div>
  <div class="filter-group">
    <label>Search</label>
    <input type="text" id="filterSearch" class="search-input" placeholder="Building name&hellip;">
  </div>
  <div class="filter-right">
    <button class="btn-sm" id="resetFilters">Reset</button>
    <div class="active-filters" id="activeFilters">Showing <strong>902</strong> of 902</div>
  </div>
</div>

<div class="main-layout">
  <!-- MAP -->
  <div class="map-container" id="mapContainer">
    <canvas id="mapCanvas" class="map-canvas"></canvas>
    <div class="map-legend">
      <h3>ENERGY STAR Score (all Grade D)</h3>
      <div class="legend-row"><div class="legend-swatch" style="background:#ef4444"></div> 1&ndash;15 &mdash; Critical</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#f59e0b"></div> 16&ndash;35 &mdash; Poor</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#fbbf24"></div> 36&ndash;54 &mdash; Below Avg</div>
      <div class="legend-row" style="margin-top:.4rem;font-size:.6rem;color:var(--text-muted)">Taller = lower score</div>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomOut">&minus;</button>
      <button class="zoom-btn" id="zoomFit" style="font-size:.7rem">FIT</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="stats-col" id="statsCol">
    <div class="detail-panel" id="detailPanel">
      <button class="close-btn" id="closeDetail">&times;</button>
      <div class="detail-name" id="detailName"></div>
      <div class="detail-addr" id="detailAddr"></div>
      <div class="detail-grid" id="detailGrid"></div>
    </div>

    <div class="stats-section">
      <h3>All Grade D &mdash; ENERGY STAR Below 55</h3>
      <div class="stat-row"><span class="label">Buildings Shown</span><span class="value" id="metricTotal">—</span></div>
      <div class="stat-row"><span class="label">Avg ENERGY STAR</span><span class="value" id="metricES">—</span></div>
      <div class="stat-row"><span class="label">Median ENERGY STAR</span><span class="value" id="metricESMed">—</span></div>
      <div class="stat-row"><span class="label">Avg Site EUI</span><span class="value" id="metricEUI">—</span></div>
    </div>

    <div class="stats-section">
      <h3>By LEED Level</h3>
      <div class="leed-bars" id="leedBars"></div>
    </div>

    <div class="stats-section">
      <h3>Certification Scope</h3>
      <div class="grade-bars" id="scopeBars"></div>
      <div style="margin-top:.5rem">
        <div class="stat-row"><span class="label">Whole-Building</span><span class="value" id="metricWhole">—</span></div>
        <div class="stat-row"><span class="label">Tenant / Interiors</span><span class="value" id="metricInteriors">—</span></div>
      </div>
    </div>

    <div class="building-list-section">
      <div class="building-list-header">
        <h3 style="font-family:var(--font-mono);font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted)">Buildings</h3>
        <span class="active-filters" id="listCount"></span>
      </div>
      <div class="building-list" id="buildingList"></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// GLOBALS
// ============================================================
let RAW_DATA = [];
let FILTERED = [];
let MAPPED = []; // buildings with valid isometric coordinates

const GRADE_COLORS = { A: '#10b981', B: '#06b6d4', C: '#f59e0b', D: '#ef4444' };
const GRADE_GLOW = { A: 'rgba(16,185,129,.35)', B: 'rgba(6,182,212,.35)', C: 'rgba(245,158,11,.35)', D: 'rgba(239,68,68,.35)' };
const LEED_COLORS = { Platinum: '#c4b5fd', Gold: '#fbbf24', Silver: '#94a3b8', Certified: '#6ee7b7' };
const GRADES = ['A','B','C','D'];
const LEED_ORDER = ['Platinum','Gold','Silver','Certified'];
const WHOLE_TYPES = new Set([
  'New Construction','Existing Buildings','Core and Shell',
  'Schools - New Construction','Schools','Healthcare',
  'Homes','Multifamily Midrise','Data Centers - New Construction',
  'Warehouse and Distribution Centers - New Construction',
]);

// Manhattan bounding box
const MH_LAT_MIN = 40.700, MH_LAT_MAX = 40.880;
const MH_LON_MIN = -74.022, MH_LON_MAX = -73.905;

// Manhattan outline (simplified polygon, lat/lon)
const MANHATTAN_OUTLINE = [
  [40.6998,-74.0187],[40.7050,-74.0170],[40.7109,-74.0145],[40.7190,-74.0131],
  [40.7292,-74.0134],[40.7388,-74.0093],[40.7425,-74.0094],[40.7485,-74.0079],
  [40.7549,-74.0050],[40.7601,-73.9988],[40.7677,-73.9901],[40.7749,-73.9821],
  [40.7839,-73.9771],[40.7940,-73.9682],[40.8005,-73.9630],[40.8070,-73.9581],
  [40.8129,-73.9532],[40.8190,-73.9464],[40.8255,-73.9395],[40.8334,-73.9341],
  [40.8395,-73.9340],[40.8460,-73.9291],[40.8530,-73.9277],[40.8590,-73.9244],
  [40.8670,-73.9211],[40.8725,-73.9106],
  [40.8715,-73.9070],[40.8685,-73.9121],[40.8615,-73.9151],[40.8530,-73.9200],
  [40.8445,-73.9212],[40.8380,-73.9262],[40.8300,-73.9283],[40.8230,-73.9341],
  [40.8160,-73.9392],[40.8090,-73.9451],[40.8020,-73.9510],[40.7940,-73.9570],
  [40.7860,-73.9630],[40.7780,-73.9682],[40.7700,-73.9748],[40.7620,-73.9710],
  [40.7540,-73.9698],[40.7450,-73.9713],[40.7360,-73.9740],[40.7280,-73.9760],
  [40.7200,-73.9766],[40.7140,-73.9775],[40.7090,-73.9795],[40.7045,-73.9975],
  [40.7008,-74.0010],[40.6998,-74.0187],
];

// ============================================================
// ISOMETRIC PROJECTION
// ============================================================
// Convert lat/lon → flat x,y → isometric
const ISO_ANGLE = Math.PI / 6; // 30 degrees
const MAP_SCALE = 5000; // pixels per degree (base)

function latLonToFlat(lat, lon) {
  const x = (lon - MH_LON_MIN) * MAP_SCALE * Math.cos((MH_LAT_MIN + MH_LAT_MAX) / 2 * Math.PI / 180);
  const y = (MH_LAT_MAX - lat) * MAP_SCALE;
  return [x, y];
}

function flatToIso(x, y) {
  const ix = (x - y) * Math.cos(ISO_ANGLE);
  const iy = (x + y) * Math.sin(ISO_ANGLE);
  return [ix, iy];
}

function geoToIso(lat, lon) {
  const [fx, fy] = latLonToFlat(lat, lon);
  return flatToIso(fx, fy);
}

// ============================================================
// CANVAS RENDERING
// ============================================================
const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');

let viewOffsetX = 0, viewOffsetY = 0, viewZoom = 1;
let isDragging = false, dragStartX = 0, dragStartY = 0;
let hoveredBuilding = null;
let selectedBuilding = null;

function resizeCanvas() {
  const container = document.getElementById('mapContainer');
  canvas.width = container.clientWidth * 2; // retina
  canvas.height = container.clientHeight * 2;
  canvas.style.width = container.clientWidth + 'px';
  canvas.style.height = container.clientHeight + 'px';
}

function drawFrame() {
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  ctx.save();
  ctx.scale(2, 2); // retina

  const cw = w / 2, ch = h / 2;

  ctx.save();
  ctx.translate(cw / 2 + viewOffsetX, ch / 2 + viewOffsetY);
  ctx.scale(viewZoom, viewZoom);

  // Draw Manhattan outline
  drawManhattanIsland();

  // Draw grid lines (streets approximation)
  drawStreetGrid();

  // Draw buildings (back to front for proper overlap)
  const sorted = [...MAPPED].sort((a, b) => a.isoY - b.isoY);
  for (const bld of sorted) {
    drawBuilding(bld);
  }

  ctx.restore();
  ctx.restore();
  requestAnimationFrame(drawFrame);
}

function drawManhattanIsland() {
  const pts = MANHATTAN_OUTLINE.map(([lat, lon]) => geoToIso(lat, lon));
  ctx.beginPath();
  ctx.moveTo(pts[0][0], pts[0][1]);
  for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
  ctx.closePath();

  // Island fill
  ctx.fillStyle = 'rgba(17,24,39,.7)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(56,189,248,.15)';
  ctx.lineWidth = 1.2;
  ctx.stroke();

  // Subtle grid texture on island
  ctx.save();
  ctx.clip();
  ctx.strokeStyle = 'rgba(56,189,248,.04)';
  ctx.lineWidth = 0.5;
  for (let lat = MH_LAT_MIN; lat <= MH_LAT_MAX; lat += 0.004) {
    const [x1, y1] = geoToIso(lat, MH_LON_MIN);
    const [x2, y2] = geoToIso(lat, MH_LON_MAX);
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
  }
  for (let lon = MH_LON_MIN; lon <= MH_LON_MAX; lon += 0.003) {
    const [x1, y1] = geoToIso(MH_LAT_MIN, lon);
    const [x2, y2] = geoToIso(MH_LAT_MAX, lon);
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
  }
  ctx.restore();
}

function drawStreetGrid() {
  // Major streets as subtle reference lines
  ctx.strokeStyle = 'rgba(56,189,248,.06)';
  ctx.lineWidth = 0.5;
}

function esColor(score) {
  if (score == null) return '#ef4444';
  if (score <= 15) return '#ef4444';
  if (score <= 35) return '#f59e0b';
  return '#fbbf24';
}
function esGlow(score) {
  if (score == null) return 'rgba(239,68,68,.35)';
  if (score <= 15) return 'rgba(239,68,68,.4)';
  if (score <= 35) return 'rgba(245,158,11,.35)';
  return 'rgba(251,191,36,.3)';
}

function drawBuilding(bld) {
  const ix = bld.isoX;
  const iy = bld.isoY;
  const color = esColor(bld.energy_star_score);
  const isHovered = hoveredBuilding === bld;
  const isSelected = selectedBuilding === bld;

  // Building height based on energy star score (inverted — lower score = taller bar for visual drama)
  const es = bld.energy_star_score;
  const baseH = 4;
  const maxH = 28;
  let h = baseH;
  if (es != null) {
    h = baseH + (maxH - baseH) * (1 - es / 100);
  }
  if (isHovered || isSelected) h += 3;

  // Isometric block dimensions
  const bw = 4; // base width
  const bd = 3; // base depth

  // Isometric offsets
  const dxR = bw * Math.cos(ISO_ANGLE);
  const dyR = bw * Math.sin(ISO_ANGLE);
  const dxL = bd * Math.cos(ISO_ANGLE);
  const dyL = bd * Math.sin(ISO_ANGLE);

  // Glow for hovered
  if (isHovered || isSelected) {
    ctx.save();
    ctx.shadowColor = esGlow(bld.energy_star_score);
    ctx.shadowBlur = 12;
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(ix, iy - h/2, 6, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  const alpha = (isHovered || isSelected) ? 1 : 0.85;

  // Top face
  ctx.beginPath();
  ctx.moveTo(ix, iy - h);
  ctx.lineTo(ix + dxR, iy - h + dyR);
  ctx.lineTo(ix + dxR - dxL, iy - h + dyR + dyL);
  ctx.lineTo(ix - dxL, iy - h + dyL);
  ctx.closePath();
  ctx.fillStyle = adjustAlpha(lighten(color, 30), alpha);
  ctx.fill();

  // Right face
  ctx.beginPath();
  ctx.moveTo(ix + dxR, iy - h + dyR);
  ctx.lineTo(ix + dxR, iy + dyR);
  ctx.lineTo(ix + dxR - dxL, iy + dyR + dyL);
  ctx.lineTo(ix + dxR - dxL, iy - h + dyR + dyL);
  ctx.closePath();
  ctx.fillStyle = adjustAlpha(darken(color, 15), alpha);
  ctx.fill();

  // Left face
  ctx.beginPath();
  ctx.moveTo(ix, iy - h);
  ctx.lineTo(ix, iy);
  ctx.lineTo(ix - dxL, iy + dyL);
  ctx.lineTo(ix - dxL, iy - h + dyL);
  ctx.closePath();
  ctx.fillStyle = adjustAlpha(color, alpha);
  ctx.fill();

  // Store hit area for interaction
  bld._hitX = ix;
  bld._hitY = iy - h / 2;
  bld._hitH = h;
}

function lighten(hex, pct) {
  const [r,g,b] = hexToRGB(hex);
  return `rgb(${Math.min(255,r+pct)},${Math.min(255,g+pct)},${Math.min(255,b+pct)})`;
}
function darken(hex, pct) {
  const [r,g,b] = hexToRGB(hex);
  return `rgb(${Math.max(0,r-pct)},${Math.max(0,g-pct)},${Math.max(0,b-pct)})`;
}
function adjustAlpha(color, a) {
  if (a >= 1) return color;
  const m = color.match(/\d+/g);
  return `rgba(${m[0]},${m[1]},${m[2]},${a})`;
}
function hexToRGB(hex) {
  const n = parseInt(hex.slice(1), 16);
  return [(n >> 16) & 255, (n >> 8) & 255, n & 255];
}

// ============================================================
// INTERACTION
// ============================================================
function getMouseIso(e) {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const cw = rect.width, ch = rect.height;
  // Reverse the viewport transform
  const ix = (mx - cw / 2 - viewOffsetX) / viewZoom;
  const iy = (my - ch / 2 - viewOffsetY) / viewZoom;
  return [ix, iy];
}

function findBuildingAt(mx, my) {
  const [ix, iy] = getMouseIso({ clientX: mx, clientY: my, target: canvas });
  let closest = null, closestDist = Infinity;
  for (const bld of MAPPED) {
    if (bld._hitX == null) continue;
    const dx = ix - bld._hitX;
    const dy = iy - bld._hitY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 8 / viewZoom && dist < closestDist) {
      closest = bld;
      closestDist = dist;
    }
  }
  return closest;
}

const mapContainer = document.getElementById('mapContainer');
const tooltip = document.getElementById('tooltip');

mapContainer.addEventListener('mousemove', (e) => {
  if (isDragging) {
    viewOffsetX += e.clientX - dragStartX;
    viewOffsetY += e.clientY - dragStartY;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    tooltip.classList.remove('visible');
    return;
  }

  const bld = findBuildingAt(e.clientX, e.clientY);
  hoveredBuilding = bld;
  canvas.style.cursor = bld ? 'pointer' : 'grab';

  if (bld) {
    document.getElementById('ttName').textContent = cleanName(bld.building_name_raw);
    document.getElementById('ttAddr').textContent = bld.address_raw || '';
    document.getElementById('ttGrade').textContent = `${bld.energy_grade || '—'}`;
    document.getElementById('ttGrade').style.color = GRADE_COLORS[bld.energy_grade] || 'var(--text-primary)';
    document.getElementById('ttLeed').textContent = bld.leed_level || '—';
    document.getElementById('ttES').textContent = bld.energy_star_score != null ? bld.energy_star_score : '—';
    document.getElementById('ttEUI').textContent = bld.site_eui != null ? bld.site_eui.toFixed(1) + ' kBtu' : '—';
    tooltip.style.left = (e.clientX + 16) + 'px';
    tooltip.style.top = (e.clientY - 10) + 'px';
    // Keep tooltip in viewport
    const tr = tooltip.getBoundingClientRect();
    if (tr.right > window.innerWidth - 10) tooltip.style.left = (e.clientX - tr.width - 16) + 'px';
    if (tr.bottom > window.innerHeight - 10) tooltip.style.top = (e.clientY - tr.height - 10) + 'px';
    tooltip.classList.add('visible');
  } else {
    tooltip.classList.remove('visible');
  }
});

mapContainer.addEventListener('mousedown', (e) => {
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  canvas.style.cursor = 'grabbing';
});
window.addEventListener('mouseup', () => { isDragging = false; });

mapContainer.addEventListener('click', (e) => {
  const bld = findBuildingAt(e.clientX, e.clientY);
  if (bld) {
    selectedBuilding = bld;
    showDetail(bld);
  }
});

mapContainer.addEventListener('wheel', (e) => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  const newZoom = Math.max(0.3, Math.min(5, viewZoom * delta));
  // Zoom toward mouse
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left - rect.width / 2;
  const my = e.clientY - rect.top - rect.height / 2;
  viewOffsetX = mx - (mx - viewOffsetX) * (newZoom / viewZoom);
  viewOffsetY = my - (my - viewOffsetY) * (newZoom / viewZoom);
  viewZoom = newZoom;
}, { passive: false });

mapContainer.addEventListener('mouseleave', () => {
  hoveredBuilding = null;
  tooltip.classList.remove('visible');
});

document.getElementById('zoomIn').addEventListener('click', () => { viewZoom = Math.min(5, viewZoom * 1.3); });
document.getElementById('zoomOut').addEventListener('click', () => { viewZoom = Math.max(0.3, viewZoom * 0.7); });
document.getElementById('zoomFit').addEventListener('click', fitView);

function fitView() {
  if (!MAPPED.length) return;
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  for (const b of MAPPED) {
    if (b.isoX < minX) minX = b.isoX;
    if (b.isoX > maxX) maxX = b.isoX;
    if (b.isoY < minY) minY = b.isoY;
    if (b.isoY > maxY) maxY = b.isoY;
  }
  const container = document.getElementById('mapContainer');
  const cw = container.clientWidth, ch = container.clientHeight;
  const dataW = maxX - minX + 60, dataH = maxY - minY + 80;
  viewZoom = Math.min(cw / dataW, ch / dataH) * 0.85;
  viewOffsetX = -(minX + maxX) / 2 * viewZoom;
  viewOffsetY = -(minY + maxY) / 2 * viewZoom;
}

// ============================================================
// DETAIL PANEL
// ============================================================
function showDetail(bld) {
  const panel = document.getElementById('detailPanel');
  panel.classList.add('visible');
  document.getElementById('detailName').textContent = cleanName(bld.building_name_raw);
  document.getElementById('detailAddr').textContent = bld.address_raw || '';

  const gradeColor = GRADE_COLORS[bld.energy_grade] || 'var(--text-primary)';
  const leedColor = LEED_COLORS[bld.leed_level] || 'var(--text-secondary)';

  document.getElementById('detailGrid').innerHTML = `
    <div class="detail-cell"><label>Energy Grade</label><div class="val" style="color:${gradeColor}">${bld.energy_grade || '—'}</div></div>
    <div class="detail-cell"><label>LEED Level</label><div class="val" style="color:${leedColor}">${bld.leed_level || '—'}</div></div>
    <div class="detail-cell"><label>ENERGY STAR</label><div class="val">${bld.energy_star_score != null ? bld.energy_star_score : '—'}</div></div>
    <div class="detail-cell"><label>Site EUI</label><div class="val">${bld.site_eui != null ? bld.site_eui.toFixed(1) : '—'} <span style="font-size:.6rem;color:var(--text-muted)">kBtu/sqft</span></div></div>
    <div class="detail-cell"><label>Project Type</label><div class="val" style="font-size:.72rem">${bld.project_type || '—'}</div></div>
    <div class="detail-cell"><label>Cert Year</label><div class="val">${bld.leed_cert_year || '—'}</div></div>
    <div class="detail-cell"><label>GHG Emissions</label><div class="val">${bld.ghg_emissions_tco2e != null ? bld.ghg_emissions_tco2e.toFixed(0) + ' tCO2e' : '—'}</div></div>
    <div class="detail-cell"><label>Match Confidence</label><div class="val">${bld.match_confidence || '—'}%</div></div>
  `;

  // Scroll sidebar to top
  document.getElementById('statsCol').scrollTop = 0;
}

document.getElementById('closeDetail').addEventListener('click', () => {
  document.getElementById('detailPanel').classList.remove('visible');
  selectedBuilding = null;
});

function cleanName(name) {
  if (!name) return 'Unknown';
  // Strip leading LEED IDs like "123456-"
  return name.replace(/^\d{5,}-?\s*/, '');
}

// ============================================================
// SIDEBAR STATS
// ============================================================
function updateSidebar() {
  const d = FILTERED;
  const n = d.length;

  // Metrics
  document.getElementById('metricTotal').textContent = n;

  // Scope bars (whole-building vs interiors)
  const wholeCount = d.filter(r => r._is_whole_building).length;
  const interiorsCount = n - wholeCount;
  const maxScope = Math.max(wholeCount, interiorsCount, 1);
  document.getElementById('scopeBars').innerHTML = [
    { label: 'Whole Bldg', count: wholeCount, color: '#ef4444' },
    { label: 'Interiors', count: interiorsCount, color: '#4a5f85' },
  ].map(s => `<div class="grade-bar-row">
    <span class="grade-bar-label" style="color:${s.color};font-size:.6rem;width:auto">${s.label}</span>
    <div class="grade-bar-track"><div class="grade-bar-fill" style="width:${(s.count/maxScope*100).toFixed(1)}%;background:${s.color}"></div></div>
    <span class="grade-bar-count">${s.count}</span>
  </div>`).join('');
  document.getElementById('metricWhole').textContent = `${wholeCount} (${n ? ((wholeCount/n)*100).toFixed(0) : 0}%)`;
  document.getElementById('metricInteriors').textContent = `${interiorsCount} (${n ? ((interiorsCount/n)*100).toFixed(0) : 0}%)`;

  // LEED bars
  const maxLeed = Math.max(...LEED_ORDER.map(l => d.filter(r => r.leed_level === l).length), 1);
  document.getElementById('leedBars').innerHTML = LEED_ORDER.map(l => {
    const count = d.filter(r => r.leed_level === l).length;
    const barPct = (count / maxLeed * 100).toFixed(1);
    return `<div class="leed-bar-row">
      <span class="leed-bar-label" style="color:${LEED_COLORS[l]}">${l}</span>
      <div class="leed-bar-track"><div class="leed-bar-fill" style="width:${barPct}%;background:${LEED_COLORS[l]}"></div></div>
      <span class="leed-bar-count">${count}</span>
    </div>`;
  }).join('');

  const esScores = d.map(r => r.energy_star_score).filter(v => v != null);
  const euis = d.map(r => r.site_eui).filter(v => v != null);

  document.getElementById('metricES').textContent = esScores.length ? (esScores.reduce((a,b)=>a+b,0)/esScores.length).toFixed(0) : '—';
  const sortedES = [...esScores].sort((a,b)=>a-b);
  document.getElementById('metricESMed').textContent = sortedES.length ? sortedES[Math.floor(sortedES.length/2)] : '—';
  document.getElementById('metricEUI').textContent = euis.length ? (euis.reduce((a,b)=>a+b,0)/euis.length).toFixed(1) + ' kBtu' : '—';

  // Building list
  const listHTML = d.slice(0, 200).map((bld, i) => {
    const gc = esColor(bld.energy_star_score);
    const es = bld.energy_star_score != null ? bld.energy_star_score : '—';
    return `<div class="building-item" data-idx="${i}">
      <div class="grade-dot" style="background:${gc}"></div>
      <div class="info">
        <div class="name">${cleanName(bld.building_name_raw)}</div>
        <div class="meta">${bld.leed_level || ''} &middot; ${bld.project_type || ''}</div>
      </div>
      <div class="es-score">${es}</div>
    </div>`;
  }).join('');
  document.getElementById('buildingList').innerHTML = listHTML;
  document.getElementById('listCount').innerHTML = `<strong>${n}</strong> buildings`;

  // Building list click → select + pan
  document.querySelectorAll('.building-item').forEach(el => {
    el.addEventListener('click', () => {
      const idx = parseInt(el.dataset.idx);
      const bld = FILTERED[idx];
      if (bld) {
        selectedBuilding = bld;
        showDetail(bld);
        if (bld.isoX != null) {
          viewOffsetX = -bld.isoX * viewZoom;
          viewOffsetY = -bld.isoY * viewZoom;
          viewZoom = Math.max(viewZoom, 2);
        }
      }
    });
  });

  document.getElementById('activeFilters').innerHTML = `Showing <strong>${n}</strong> of ${RAW_DATA.length}`;
}

// ============================================================
// FILTERING
// ============================================================
function applyFilters() {
  const leed = document.getElementById('filterLeed').value;
  const type = document.getElementById('filterType').value;
  const search = document.getElementById('filterSearch').value.toLowerCase().trim();

  FILTERED = RAW_DATA.filter(r => {
    if (leed && r.leed_level !== leed) return false;
    if (type && r.project_type !== type) return false;
    if (search) {
      const name = (r.building_name_raw || '').toLowerCase();
      const addr = (r.address_raw || '').toLowerCase();
      if (!name.includes(search) && !addr.includes(search)) return false;
    }
    return true;
  });

  MAPPED = FILTERED.filter(b => b.isoX != null);
  updateSidebar();
}

document.querySelectorAll('.filter-bar select, .filter-bar input').forEach(el => {
  el.addEventListener(el.tagName === 'INPUT' ? 'input' : 'change', applyFilters);
});
document.getElementById('resetFilters').addEventListener('click', () => {
  document.querySelectorAll('.filter-bar select').forEach(s => s.value = '');
  document.getElementById('filterSearch').value = '';
  applyFilters();
});

// ============================================================
// LOAD DATA
// ============================================================
async function loadData() {
  const resp = await fetch('data.csv');
  const text = await resp.text();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true, dynamicTyping: true });

  RAW_DATA = parsed.data.map(row => {
    const lat = parseFloat(row.lat) || null;
    const lon = parseFloat(row.lon) || null;
    let isoX = null, isoY = null;
    if (lat && lon && lat > 40.6 && lat < 41 && lon > -74.1 && lon < -73.8) {
      [isoX, isoY] = geoToIso(lat, lon);
    }
    return {
      ...row,
      energy_star_score: parseFloat(row.energy_star_score) || null,
      site_eui: parseFloat(row.site_eui) || null,
      leed_cert_year: parseInt(row.leed_cert_year) || null,
      match_confidence: parseInt(row.match_confidence) || null,
      ghg_emissions_tco2e: parseFloat(row.ghg_emissions_tco2e) || null,
      gross_sqft: parseFloat(row.gross_sqft) || null,
      lat, lon, isoX, isoY,
      _is_whole_building: WHOLE_TYPES.has(row.project_type),
    };
  });

  // Populate filter dropdowns
  const types = [...new Set(RAW_DATA.map(r => r.project_type).filter(Boolean))].sort();
  const typeEl = document.getElementById('filterType');
  types.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; typeEl.appendChild(o); });

  FILTERED = [...RAW_DATA];
  MAPPED = FILTERED.filter(b => b.isoX != null);

  resizeCanvas();
  fitView();
  updateSidebar();
  drawFrame();

  document.getElementById('loading').classList.add('hidden');
}

window.addEventListener('resize', () => { resizeCanvas(); });

loadData().catch(err => {
  console.error(err);
  document.getElementById('loading').innerHTML =
    `<div style="color:#ef4444;font-family:var(--font-mono);font-size:.85rem;text-align:center;padding:2rem">
      Failed to load data. Serve from repo root: <code style="color:#38bdf8">python -m http.server 8080</code>
    </div>`;
});
</script>
</body>
</html>
